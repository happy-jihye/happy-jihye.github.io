---
title: "[Paper Review] BDInvert: GAN Inversion for Out-of-Range Images with Geometric Transformations ë…¼ë¬¸ ë¦¬ë·°"
excerpt: " "


categories:
 - GAN
tags:
  - deeplearning
  - ai
  - GAN
  - vision
search: true

# ëª©ì°¨
toc: true  
toc_sticky: true 

use_math: true
---

- Paper : [GAN Inversion for Out-of-Range Images with Geometric Transformations](https://arxiv.org/abs/2108.08998) (ICCV 2021 / Kyoungkook Kang, Seongtae Kim, Sunghyun Cho)

- [GAN-Zoos! (GAN í¬ìŠ¤íŒ… ëª¨ìŒì§‘)](https://happy-jihye.github.io/gan/)

---

## Base-Detail Invert (BDInvert)

> ğŸ¤” ê²°ê³¼ê°€ êµ‰ì¥íˆ ì¸ìƒì ì¸ ëª¨ë¸ì´ ë‚˜ì™”ë‹¤. ì˜¬í•´ í¬ìŠ¤í…ì—ì„œ ë°œí‘œí•œ `BDInvert`ë¼ëŠ” ëª¨ë¸ì¸ë°, alignì´ ë§ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ì„œë„ inversion ë° reconstructionì„ ì˜í•œë‹¤. 
> 
> ì•„ì§ image editing ì„±ëŠ¥ê³¼ ì†ë„ë©´ì—ì„œëŠ” í•œê³„ê°€ ìˆì–´ë³´ì´ì§€ë§Œ, alignmentë¥¼ ê°•í•˜ê²Œ ê±¸ì–´ì•¼í•˜ëŠ” stylegan-based modelì„ alignì´ ì•ˆëœ ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ì„œë„ ì˜ ìƒì„±ë˜ë„ë¡ ë§Œë“¤ì—ˆë‹¤ëŠ” ì ì—ì„œ ì•„ì£¼ impressiveí•œ ëª¨ë¸ì¸ ê²ƒ ê°™ë‹¤.



- GAN Inversionì€ in-domainì— ìˆëŠ” latent codeë¥¼ ì°¾ëŠ”ê²Œ ì¤‘ìš”í•˜ì§€ë§Œ, ê·¸ë™ì•ˆì€ alignì´ ì˜ëœ ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ì„œë§Œ `in-domain latent code`ë¥¼ êµ¬í•  ìˆ˜ ìˆì—ˆë‹¤.
- `BDInvert`ì—ì„œëŠ” ì´ ë¬¸ì œì ì„ ê¼¬ì§‘ì–´ alignì´ ì•ˆëœ ì´ë¯¸ì§€ì— ëŒ€í•´ì„œë„ inversionì„ ì˜í•  ìˆ˜ ìˆë„ë¡ ë§Œë“ ë‹¤.
- ì €ìë“¤ì€ `BDInvert`ê°€ semantic editingì´ ê°€ëŠ¥í•˜ë„ë¡ **regularized inversion** ë°©ì‹ì„ ì œì•ˆí•˜ì—¬ latent codeë¥¼ 
`alternative latent space`ë¡œ inversioní•˜ì˜€ë‹¤.

<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-1.png?raw=1' width = '800' ></p>

Real imageë¥¼ editing í•˜ë ¤ë©´ GANì˜ pre-trained modelê³¼ alignì´ ì˜ëœ *in-domain* latent codeë¥¼ ì°¾ì•„ì•¼í•œë‹¤. 
- *out-domain*ì— ìˆëŠ” latent codeë¥¼ ì°¾ìœ¼ë©´ image reconstructionì€ ì˜ë˜ì§€ë§Œ, editing ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŒ
  - ì´ ê¸€ ì°¸ê³ : [GAN Inversion / Encoder : Image2stylegan, IDInvert, pSp, e4e](https://happy-jihye.github.io/gan/gan-23/)

alignì´ ì•ˆëœ ì´ë¯¸ì§€ë¥¼ ë„£ìœ¼ë©´ `Fig1` ì²˜ëŸ¼ ì´ìƒí•œ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ë©°, image manipulation ì—­ì‹œ ì˜ ì•ˆëœë‹¤. ë³¸ ë…¼ë¬¸ì—ì„œëŠ” alignì´ ì•ˆëœ ì´ë¯¸ì§€(ex. translation, rotation, scaling..)ì— ëŒ€í•´ì„œë„ reconê³¼ editingì´ ì˜ë˜ë„ë¡ styleganì˜ architectureë¥¼ ë°œì „ì‹œì¼°ë‹¤.

## Model

### Alternative Latent Space $\mathcal{F} / \mathcal{W}^{+}$

*out-of-range image* (unaligned image)ëŠ” pre-trained GAN modelì˜ original spaceë¡œ inversion ë˜ê¸° ì–´ë µë‹¤. ë”°ë¼ì„œ ë³¸ ë…¼ë¬¸ì—ì„œëŠ” $\mathcal{F} / \mathcal{W}^{+}$ ë¼ëŠ” ìƒˆë¡œìš´ latent spaceë¥¼ ì œì•ˆí•˜ë©° ì´ë¯¸ì§€ë¥¼ ì´ spaceë¡œ inversion í•œë‹¤.


<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-2.png?raw=1' width = '800' ></p>




<span style='background-color: #E5EBF7;'> **1. The base code space $\mathcal{F}$** </span>

- $\mathbf{w}_{M}$ ì´ ë“¤ì–´ê°€ê¸° ì „ì— ìˆëŠ”, generatorì˜ coarse-scale feature map
- `StyleGAN v1`ì—ì„œëŠ” íŠ¹ì • scaleì˜ AdaIN layer ë°”ë¡œ ì§ì „ì— $f$ ë¥¼ ë‘ì—ˆê³ , `StyleGAN v2`ì—ì„œëŠ” íŠ¹ì • scaleì˜ conv layer ë°”ë¡œ ì§ì „ì— $f$ ë¥¼ ë‘ 
- ë³¸ ë…¼ë¬¸ì—ì„œëŠ” `8x8`, `16x16` scaleì— $f$ë¥¼ ë‘ì–´ì„œ ì‹¤í—˜í•˜ì˜€ìŒ 

- $f$ ëŠ” imageë¥¼ wildí•˜ê²Œ encoding ! (geometric transformationì„ encoding)
- image editingì´ ê°€ëŠ¥í•˜ë„ë¡ ë‹¤ì–‘í•œ local variationì„ ì§€ì›
- ì˜ˆë¥¼ ë“¤ì–´, $f$ ê°€ CNNì˜ feature mapì´ë¼ë©´ ë‹¨ìˆœíˆ $f$ ë¥¼ xë‚˜ yì¶•ì˜ ë°©í–¥ìœ¼ë¡œ shiftí•¨ìœ¼ë¡œì¨ shifedëœ imageë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ

<span style='background-color: #E5EBF7;'> **2. The detail code space $\mathcal{W}^{+}$** </span>

- $\mathbf{w}_{M+}=\left\{\mathbf{w}_{M}, \cdots, \mathbf{w}_{N}\right\}$ : generatorì˜ fine scaleí•˜ê²Œ ì¡°ì ˆí•˜ê¸° ìœ„í•œ latent code


- geometric transformationê³¼ ë¬´ê´€. ì¦‰ imageì˜ translationì— invariant í•¨
  - $\mathcal{W}_{M+}$ëŠ” `StyleGAN v1, v2`ì—ì„œ AdaINì´ë‚˜ demodulation operationìœ¼ë¡œ ì¡°ì ˆë˜ë¯€ë¡œ imageì˜ translationì— invariant í•¨
- sementic manipulationì´ ê°€ëŠ¥í•˜ë„ë¡ ì§€ì›

<span style='background-color: #E5EBF7;'> **3. RGB Block** </span>

- `StyleGAN v2`ì—ì„œëŠ” ê° block ë§ˆë‹¤ RGB ê°’ì„ êµ¬í•œ í›„, ì´ë¥¼ upsampleí•˜ì—¬ ë‹¤ìŒ scaleì˜ RGBì™€ ë”í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ RGB feature mapì„ ë½‘ìŒ: [ì°¸ê³  ë§í¬](https://happy-jihye.github.io/gan/gan-7/#41-alternative-network-architectures)
- ë³¸ ë…¼ë¬¸ì€ ì•„ë«ë‹¨ì˜ blockì„ ë‚ ë ¤ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì´ˆê¸° RGBê°’ì´ ì—†ìŒ
- ì €ìë“¤ì€ ì‹¤í—˜ ì¤‘ small-scaleì—ì„œ ê´€ì°°ë˜ëŠ” feature mapì´ ê±°ì˜ 0ì— ìˆ˜ë ´í•˜ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ê³ , ê·¸ë¦¼ 2(c)ì²˜ëŸ¼ ì´ˆê¸°ê°’ì„ 0ìœ¼ë¡œ ë‘ 


$$\mathbf{w}^{*}=\left(\mathbf{f}, \mathbf{w}_{M+}\right)$$



<span style='background-color: #E5EBF7;'> **4. Generate Images** </span>

original image $I$

$$I=G\left(\mathbf{w}^{*}\right)=G\left(\mathbf{f}, \mathbf{w}_{M+}\right)$$

transformed image $T(I)$

$$T(I) \approx G\left(T^{\prime}(\mathbf{f}), \mathbf{w}_{M+}\right)$$

  - $T'$ : a **geometric transformation operator** corresponding to $T$ whose scale is adjusted according to the relative scale of $f$ to $I$

<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-3.png?raw=1' width = '700' ></p>

**(a)** in-domain latent code $\left(\mathbf{f}, \mathbf{w}_{M+}\right)$ ë¥¼ sampling í•œ ë‹¤ìŒì— StyleGAN2ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±

**(b)** $f$ ë¥¼ shift í•˜ì—¬ shiftëœ ì´ë¯¸ì§€ë¥¼ ìƒì„±

**(c)** manipulated latent code $\mathbf{w'}_{M+}$ ë¥¼ í†µí•´ imageë¥¼ semanticí•˜ê²Œ editing í•¨

**(d)** (b)ì™€ (c)ë¥¼ ê°™ì´


---
### Regularized Inversion to $\mathcal{F} / \mathcal{W}^{+}$

#### Optimization Approach

ë³¸ ë…¼ë¬¸ì€ optimization ë°©ì‹ìœ¼ë¡œ latent codeë¥¼ êµ¬í•œë‹¤. optimization ë°©ì‹ìœ¼ë¡œ latent codeë¥¼ êµ¬í•˜ë©´ reconì€ ë§¤ìš° ì˜ë˜ì§€ë§Œ sementicí•œ editingì´ ì–´ë ¤ì›Œì§€ë¯€ë¡œ, encoder networkë¥¼ baseë¡œ í•˜ì—¬ ì¶”ê°€ì ìœ¼ë¡œ regularizationì„ í•œë‹¤.

Encoderë¥¼ ì‚¬ìš©í•˜ê¸°ëŠ” í•˜ì§€ë§Œ, ì´ëŠ” latent codeì˜ ì •ê·œí™”ë¥¼ ìœ„í•´ì„œ í•˜ëŠ”ê±°ì§€ Encoderì—ì„œ êµ¬í•œ initial latent codeì—ì„œ ì¶œë°œí•˜ì—¬ optimizationì„ í•˜ëŠ” hybridí•œ ë°©ì‹ì€ ì•„ë‹ˆë¯€ë¡œ latent vectorë¥¼ êµ¬í•  ë•Œ ì†ë„ì ìœ¼ë¡œëŠ” êµ‰ì¥íˆ ëŠë¦¬ë‹¤.

#### Reconstruction Loss

ì´ë¯¸ì§€ $I$ ê°€ ì£¼ì–´ì§€ë©´, recon lossë¡œ latent code $\mathbf{w}^{*}$ ë¥¼ ì°¾ìŒ

$$L_{\text {recon }}\left(\mathbf{w}^{*}\right)=L_{M S E}\left(\mathbf{w}^{*}\right)+\omega_{p e r} L_{p e r}\left(\mathbf{w}^{*}\right)$$

- $L_{M S E}$ : MSE(mean-squared-error) loss

$$L_{M S E}\left(\mathbf{w}^{*}\right)=\left\|I-G\left(\mathbf{w}^{*}\right)\right\|^{2}$$

- $L_{p e r}$ : perceptual loss
  - $F$ : perceptual distanceë¥¼ êµ¬í•´ì£¼ëŠ” LPIPS network

$$L_{\text {per }}\left(\mathbf{w}^{*}\right)=\left\|F(I)-F\left(G\left(\mathbf{w}^{*}\right)\right)\right\|^{2}$$

<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-4.png?raw=1' width = '600' ></p>

ë‹¤ë§Œ recon lossë¡œ optimizeí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ latent codeë¥¼ êµ¬í•˜ë©´, image reconì€ ì˜ë˜ì§€ë§Œ out-domainìœ¼ë¡œ inversionë˜ì–´ editingì´ ì˜ ì•ˆëœë‹¤. (`Fig 4(f)` ì°¸ê³ )

ë”°ë¼ì„œ ë³¸ ì €ìë“¤ì€ $\mathbf{f}, \mathbf{w}_{M+}$ ë¥¼ regularization í•˜ëŠ” ë°©ì‹ì„ í†µí•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ì í•˜ì˜€ë‹¤.

#### Regularization on Detail Code $\mathbf{w}_{M+}$

ë³¸ ë…¼ë¬¸ì—ì„œëŠ” $\mathbf{w}_{M+}$ ë¥¼ in-domain spaceë¡œ ë³´ë‚´ê¸° ìœ„í•´ ë‹¤ìŒ ë…¼ë¬¸ì—ì„œ ì œì‹œëœ **$\mathcal{P}-\text { norm }^{+}$ space-based regularization** ë°©ì‹ì„ ì‚¬ìš©í•˜ì˜€ë‹¤

- [Improved stylegan embedding: Where are the good latents? (2020)](https://arxiv.org/abs/2012.09036)


#### Regularization on Base Code $\mathbf{f}$

`Fig 4(g)`ë¥¼ ë³´ë©´, $\mathbf{w}_{M+}$ì˜ regularization ë§Œìœ¼ë¡œ ë¬¸ì œê°€ í•´ê²°ë˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ë³¸ ë…¼ë¬¸ì—ì„œëŠ” $\mathbf{f}$ ì—­ì‹œ ì •ê·œí™”ë¥¼ ì‹œì¼°ë‹¤.

$\mathbf{f}$ ëŠ” regularizationì„ ìœ„í•´ encoderì—ì„œ êµ¬í•œ initial latent code $\mathbf{f}^{o}$ ì™€ ê°’ì´ ë¹„ìŠ·í•˜ë„ë¡ regularization loss $L_{\mathbf{f}}\left(\mathbf{w}^{*}\right)$ ë¡œ ì œì•½ì„ ì¤€ë‹¤. 

$$L_{\mathbf{f}}\left(\mathbf{w}^{*}\right)=\left\|\mathbf{f}^{o}-\mathbf{f}\right\|^{2}$$

$$L\left(\mathbf{w}^{*}\right)=L_{r e c o n}\left(\mathbf{w}^{*}\right)+\omega_{\mathbf{f}} L_{\mathbf{f}}\left(\mathbf{w}^{*}\right)$$

#### Encoder for Base Code $\mathbf{f}$

EncoderëŠ” initial base code $\mathbf{f}^{o}$ ë¥¼ ì¶”ì •í•˜ëŠ”ê²Œ ëª©í‘œì´ë‹¤. $\mathbf{f}^{o}$ëŠ” `8x8`ì´ë‚˜ `16x16`ê³¼ ê°™ì€ small-spatial resolutionì„ ê°€ì§€ë¯€ë¡œ encoderëŠ” í•™ìŠµí•  ë•Œ original resolutionì˜ ì´ë¯¸ì§€ë¥¼ inputìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°(down-scalingëœ ê±¸ ì‚¬ìš©), network ìì²´ë„ ê¸°ì¡´ì— ë¹„í•´ ê°€ë³ë‹¤.

EncoderëŠ” VGG networkì™€ ë¹„ìŠ·í•˜ê²Œ 11ê°œì˜ conv blockê³¼ 3ê°œì˜ pooling layerë¡œ êµ¬ì„±ëœë‹¤.

<span style='background-color: #E5EBF7;'> **Training** </span>

- randomìœ¼ë¡œ latent code $z$ë¥¼ ìƒì„±í•œ í›„, $z$ë¡œë¶€í„° $\left(\mathbf{f}^{g t}, \mathbf{w}_{M+}^{g t}\right)$ ì™€ ìƒì„±ëœ ì´ë¯¸ì§€ $I$ ë¥¼ êµ¬í•¨


$$\begin{aligned}
L_{e n c} &=\left\|G\left(E\left(I_{\downarrow}\right), \mathbf{w}_{M+}^{g t}\right)-I\right\|^{2} \\
&+\lambda_{p e r}\left\|F\left(G\left(E\left(I_{\downarrow}\right), \mathbf{w}_{M+}^{g t}\right)\right)-F(I)\right\|^{2}
\end{aligned}$$

- ì´ë¯¸ì§€ $I$ë¥¼ downscaling í•œ ì´ë¯¸ì§€ê°€ $I_{\downarrow}$
- loss functionì—ì„œ ì²«ë²ˆì§¸ê°€ mse loss, ë‘ë²ˆì§¸ê°€ perceptual loss


> ğŸ§ base codeì— ëŒ€í•œ ground trouth $\mathbf{f}^{g t}$ë¥¼ ì•Œê³  ìˆëŠ”ë°, ì™œ ë‹¤ìŒê³¼ ê°™ì€ Loss functiondìœ¼ë¡œ encoderë¥¼ í•™ìŠµí–ˆì„ê¹Œ?
> 
> ì €ìë“¤ì€ ì§ì ‘ ì‹¤í—˜í•´ë³¸ ê²°ê³¼ $\left\|E\left(I_{\downarrow}\right)-\mathbf{f}^{g t}\right\|^{2}$ ì™€ ê°™ì´ $\mathbf{f}^{g t}$ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ encoderë¥¼ í•™ìŠµì‹œí‚¤ë©´ ì˜¤íˆë ¤ recon ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤ê³  ë³´ê³ í•œë‹¤.

ë˜, ì €ìë“¤ì€ ì´ encoderê°€ ê¸°í•˜í•™ì ìœ¼ë¡œ ë³€í˜•ëœ ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ì„œë„ ì˜ encodingí•œë‹¤ê³  ë³´ê³ í•œë‹¤. ì´ëŠ” CNN ìì²´ê°€ spatially-invariantí•œ íŠ¹ì„±ì„ ê°–ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤.

## Experiments

- FFHQ ë°ì´í„°ì…‹ìœ¼ë¡œ í•™ìŠµëœ pretrained modelê³¼ CelebA-HQì—ì„œ randomìœ¼ë¡œ ë½‘ì€ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©


<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-5.png?raw=1' width = '800' ></p>
<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-6.png?raw=1' width = '800' ></p>

> Recon ë¿ë§Œ ì•„ë‹ˆë¼ sementicí•œ editingë„ ì˜ë¨


<p align='center'><img src='https://github.com/happy-jihye/happy-jihye.github.io/blob/master/_posts/images/gan/BDInvert-7.png?raw=1' width = '800' ></p>


- base code $f$ ë¡œëŠ” `8x8`, `16x16` ì„ ì‚¬ìš©
- `8x8`ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œê°€ sementicí•œ editingì´ ë” ì˜ëœë‹¤ê³  ë³´ê³ 


---

ë§ˆì¹˜ë©°..

> êµ‰ì¥íˆ í¥ë¯¸ë¡­ê²Œ ë³¸ ë…¼ë¬¸ì´ë‹¤ ! githubì— ì½”ë“œê°€ ê³µê°œë˜ì–´ìˆë˜ë°,, í•œë²ˆ ì‹¤í—˜í•´ë³´ê³  ì„±ëŠ¥ì´ ì–´ë–¤ì§€ ì§ì ‘ í™•ì¸í•´ë´ì•¼ê² ë‹¤ ğŸ˜Š